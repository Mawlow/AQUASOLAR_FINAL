<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AquaSolar Dashboard</title>
  <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="light dark">
  <style>
    /* Dark Mode Variables */
    :root {
      color-scheme: light;
    }
  
    html.dark {
      color-scheme: dark;
    }
  
    /* Dark Mode Styles */
    html.dark {
      background-color: #0f172a;
      color: #e2e8f0;
    }
  
    html.dark body {
      background-color: #0f172a;
      color: #e2e8f0;
    }
  
    html.dark header {
      background-color: #1e293b !important;
      border-color: #334155 !important;
    }
  
    html.dark .bg-white {
      background-color: #1e293b !important;
    }
  
    html.dark .text-gray-900 {
      color: #f1f5f9 !important;
    }
  
    html.dark .text-gray-700 {
      color: #cbd5e1 !important;
    }
  
    html.dark .text-gray-600 {
      color: #94a3b8 !important;
    }
  
    html.dark .text-gray-500 {
      color: #78909c !important;
    }
  
    html.dark .border-gray-200 {
      border-color: #334155 !important;
    }
  
    html.dark .border-gray-100 {
      border-color: #1e293b !important;
    }
  
    html.dark .bg-gray-50 {
      background-color: #1e293b !important;
    }
  
    html.dark .bg-gray-100 {
      background-color: #334155 !important;
    }
  
    html.dark .hover\:bg-gray-50:hover {
      background-color: #1e293b !important;
    }
  
    html.dark .hover\:bg-gray-100:hover {
      background-color: #334155 !important;
    }
  
    html.dark input,
    html.dark textarea,
    html.dark select {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
  
    html.dark input:focus,
    html.dark textarea:focus,
    html.dark select:focus {
      border-color: #10b981 !important;
    }
  
    html.dark .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }
  
    /* Scrollbar Dark Mode */
    html.dark ::-webkit-scrollbar-track {
      background: #1e293b;
    }
  
    html.dark ::-webkit-scrollbar-thumb {
      background: #475569;
    }
  
    html.dark ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    * { font-family: 'Inter', system-ui, sans-serif; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes countUp {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    .animate-slide-up { animation: slideUp 0.4s ease-out; }
    .animate-count { animation: countUp 0.3s ease-out; }
    .pulse-glow { animation: pulse-glow 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    .card-interactive {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-interactive:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .card-interactive:active {
      transform: translateY(-2px);
    }

    .btn-press {
      transition: all 0.15s ease;
    }
    .btn-press:active {
      transform: scale(0.97);
    }

    @media (hover: none) {
      .card-interactive:active {
        transform: scale(0.98);
        background-color: #f9fafb;
      }
    }

    .value-update {
      transition: all 0.3s ease;
    }
    .value-flash {
      animation: countUp 0.3s ease-out;
    }
    
    /* Modal styles */
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      animation: slideUp 0.3s ease-out;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <script type="module">
    import Chatbot from "https://cdn.jsdelivr.net/gh/firefoxd92-sys/FlowiseChatEmbed@latest/dist/web.js"
    Chatbot.init({
        chatflowid: "25d294ae-e6b6-4b51-8737-b1f428c5a40f",
        apiHost: "https://cloud.flowiseai.com",
    })
</script>
  <!-- Mobile Menu Overlay -->
  <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" onclick="closeMobileMenu()"></div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white bg-opacity-80 backdrop-blur-lg border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16 sm:h-20">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <img src="{{ url_for('static', filename='images/Solar.png') }}" alt="Logo"
               class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl shadow-sm">
          <h1 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900 tracking-tight">
            AquaSolar
          </h1>
        </div>
        
         <!-- Dark Mode Toggle Button -->
        <button id="dark-mode-toggle" 
                class="p-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 btn-press">
          <i data-lucide="moon" class="w-5 h-5 text-gray-700 dark:text-gray-300"></i>
        </button>
        <!-- Desktop Actions -->
        <div class="hidden sm:flex items-center gap-3">
          <!-- Usage Summary Button -->
          <button id="usage-summary-btn" 
                  class="flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 btn-press">
            <i data-lucide="file-text" class="w-5 h-5 text-gray-700"></i>
            <span class="text-sm font-medium text-gray-700 hidden md:inline">Reports</span>
          </button>
          
          <!-- Notification -->
          <div class="relative">
            <button id="notif-btn" 
                    class="relative p-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 btn-press">
              <i data-lucide="bell" class="w-5 h-5 text-gray-700"></i>
              <span id="notif-count" 
                    class="absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center px-1 hidden">
                0
              </span>
            </button>
            <div id="notif-dropdown" 
                 class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-2xl shadow-xl z-50 overflow-hidden animate-fade-in">
              <div class="p-4 border-b border-gray-100 bg-gray-50 bg-opacity-50 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Notifications</h3>
                <button id="clear-notif" class="text-xs text-red-500 hover:text-red-700 font-medium transition-colors">Clear all</button>
              </div>
              <ul id="notif-list" class="max-h-72 overflow-y-auto divide-y divide-gray-100">
                <li class="p-4 text-center text-gray-400 text-sm">No notifications</li>
              </ul>
            </div>
          </div>

          <!-- History -->
          <div class="relative">
            <button id="history-btn" 
                    class="relative p-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 transition-all duration-200 btn-press">
              <i data-lucide="clock" class="w-5 h-5 text-gray-700"></i>
            </button>
            <div id="history-dropdown" 
                 class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-2xl shadow-xl z-50 overflow-hidden animate-fade-in">
              <div class="p-4 border-b border-gray-100 bg-gray-50 bg-opacity-50 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">History</h3>
              </div>
              <ul id="history-list" class="max-h-72 overflow-y-auto divide-y divide-gray-100">
                <li class="p-4 text-center text-gray-400 text-sm">No history yet</li>
              </ul>
            </div>
          </div>

          <!-- Divider -->
          <div class="w-px h-8 bg-gray-200 mx-2"></div>

          <!-- User Profile -->
          <div class="flex items-center gap-3">
            <button id="profile-btn" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-100 transition-colors btn-press">
              <div class="w-9 h-9 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center">
                <span class="text-black font-semibold text-sm">{{ user_name[:1] }}</span>
              </div>
              <div class="text-left hidden md:block">
                <p class="text-sm font-semibold text-gray-900">{{ user_name }}</p>
                <p class="text-xs text-gray-500">View Profile</p>
              </div>
              <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 hidden md:block"></i>
            </button>
            <a href="{{ url_for('logout') }}" 
               class="px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-semibold rounded-xl transition-all duration-200 btn-press">
              Logout
            </a>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <div class="flex items-center gap-2 sm:hidden">
          <button id="mobile-report-btn" class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <i data-lucide="file-text" class="w-5 h-5 text-gray-700"></i>
          </button>
          <button id="mobile-notif-btn" class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <i data-lucide="bell" class="w-5 h-5 text-gray-700"></i>
            <span id="mobile-notif-count" 
                  class="absolute -top-0 -right-0 min-w-4 h-4 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center px-1 hidden">
              0
            </span>
          </button>
          <button id="mobile-menu-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <i data-lucide="menu" class="w-5 h-5 text-gray-700"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Slide Menu -->
  <div id="mobile-menu" 
       class="fixed top-0 right-0 h-full w-72 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-out lg:hidden">
    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
      <h2 class="font-semibold text-gray-900">Menu</h2>
      <button onclick="closeMobileMenu()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
        <i data-lucide="x" class="w-5 h-5 text-gray-700"></i>
      </button>
    </div>
    <div class="p-4 space-y-4">
      <button onclick="openProfileModal(); closeMobileMenu();" class="w-full p-4 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-xl flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center">
          <span class="text-white font-bold text-lg">{{ user_name[:1] }}</span>
        </div>
        <div class="text-left">
          <p class="font-semibold text-gray-900">{{ user_name }}</p>
          <p class="text-xs text-emerald-600">Tap to view profile</p>
        </div>
      </button>
      <button onclick="openUsageSummaryModal(); closeMobileMenu();" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors">
        <i data-lucide="file-text" class="w-5 h-5 text-gray-600"></i>
        <span class="text-gray-700">Usage Reports</span>
      </button>
      <button onclick="openMobileNotifications()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors">
        <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
        <span class="text-gray-700">Notifications</span>
      </button>
      <button onclick="openMobileHistory()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors">
        <i data-lucide="clock" class="w-5 h-5 text-gray-600"></i>
        <span class="text-gray-700">History</span>
      </button>
      <a href="{{ url_for('logout') }}" 
         class="w-full flex items-center gap-3 p-3 rounded-xl bg-gray-900 text-white hover:bg-gray-800 transition-colors">
        <i data-lucide="log-out" class="w-5 h-5"></i>
        <span class="font-medium">Logout</span>
      </a>
    </div>
  </div>

  <!-- Mobile Bottom Sheet for Notifications -->
  <div id="mobile-notif-sheet" 
       class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl z-50 transform translate-y-full transition-transform duration-300 ease-out lg:hidden" style="max-height: 70vh;">
    <div class="p-4 border-b border-gray-100">
      <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">Notifications</h3>
        <button id="mobile-clear-notif" class="text-xs text-red-500 font-medium">Clear all</button>
      </div>
    </div>
    <ul id="mobile-notif-list" class="overflow-y-auto divide-y divide-gray-100" style="max-height: 50vh;">
      <li class="p-4 text-center text-gray-400 text-sm">No notifications</li>
    </ul>
  </div>

  <!-- Mobile Bottom Sheet for History -->
  <div id="mobile-history-sheet" 
       class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl z-50 transform translate-y-full transition-transform duration-300 ease-out lg:hidden" style="max-height: 70vh;">
    <div class="p-4 border-b border-gray-100">
      <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">History</h3>
      </div>
    </div>
    <ul id="mobile-history-list" class="overflow-y-auto divide-y divide-gray-100" style="max-height: 50vh;">
      <li class="p-4 text-center text-gray-400 text-sm">No history yet</li>
    </ul>
  </div>

  <!-- Usage Summary Modal -->
  <div id="usage-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeUsageSummaryModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="modal-content bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white border-b border-gray-100 p-4 sm:p-6 flex items-center justify-between z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-emerald-100 flex items-center justify-center">
              <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 text-emerald-600"></i>
            </div>
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-gray-900">Usage Summary</h2>
              <p class="text-xs sm:text-sm text-gray-500">Generate and download reports</p>
            </div>
          </div>
          <button onclick="closeUsageSummaryModal()" class="p-2 rounded-xl hover:bg-gray-100 transition-colors">
            <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-4 sm:p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
          <!-- Date Range Selection -->
          <div class="bg-gray-50 rounded-2xl p-4 mb-6">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Select Date Range</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Start Date</label>
                <input type="date" id="start-date" 
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">End Date</label>
                <input type="date" id="end-date" 
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
              </div>
            </div>
            
            <!-- Quick Select Buttons -->
            <div class="flex flex-wrap gap-2 mt-4">
              <button onclick="setDateRange(7)" class="px-3 py-1.5 text-xs font-medium bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">Last 7 days</button>
              <button onclick="setDateRange(30)" class="px-3 py-1.5 text-xs font-medium bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">Last 30 days</button>
              <button onclick="setDateRange(90)" class="px-3 py-1.5 text-xs font-medium bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">Last 90 days</button>
              <button onclick="setThisMonth()" class="px-3 py-1.5 text-xs font-medium bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">This Month</button>
            </div>
            
            <button onclick="fetchUsageSummary()" 
                    class="w-full mt-4 py-3 bg-gray-600 hover:bg-gray-700 text-black font-semibold rounded-xl transition-all btn-press flex items-center justify-center gap-2">
              <i data-lucide="search" class="w-4 h-4"></i>
              <span>Generate Report</span>
            </button>
          </div>
          
          <!-- Loading State -->
          <div id="summary-loading" class="hidden py-12 text-center">
            <div class="w-12 h-12 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-500">Fetching data...</p>
          </div>
          
          <!-- Summary Results -->
          <div id="summary-results" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                <p class="text-xs text-blue-600 font-medium mb-1">Total Water</p>
                <p id="summary-total-water" class="text-xl sm:text-2xl font-bold text-blue-700">0 L</p>
              </div>
              <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-4">
                <p class="text-xs text-emerald-600 font-medium mb-1">Avg Daily</p>
                <p id="summary-avg-daily" class="text-xl sm:text-2xl font-bold text-emerald-700">0 L</p>
              </div>
              <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4">
                <p class="text-xs text-amber-600 font-medium mb-1">Pump Cycles</p>
                <p id="summary-pump-cycles" class="text-xl sm:text-2xl font-bold text-amber-700">0</p>
              </div>
              <div class="bg-gradient-to-br from-rose-50 to-rose-100 rounded-xl p-4">
                <p class="text-xs text-rose-600 font-medium mb-1">Alerts</p>
                <p id="summary-alerts" class="text-xl sm:text-2xl font-bold text-rose-700">0</p>
              </div>
            </div>
            
            <!-- Daily Consumption Chart -->
            <div class="bg-white border border-gray-200 rounded-2xl p-4 mb-6">
              <h3 class="text-sm font-semibold text-gray-700 mb-4">Daily Consumption</h3>
              <div class="h-48 sm:h-64">
                <canvas id="summaryChart"></canvas>
              </div>
            </div>
            
            <!-- Data Table -->
            <div class="bg-white border border-gray-200 rounded-2xl overflow-hidden mb-6">
              <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">Daily Breakdown</h3>
                <span id="summary-date-range" class="text-xs text-gray-500"></span>
              </div>
              <div class="overflow-x-auto max-h-64">
                <table class="w-full">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Date</th>
                      <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Consumption (L)</th>
                      <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Pump Cycles</th>
                    </tr>
                  </thead>
                  <tbody id="summary-table-body" class="divide-y divide-gray-100">
                    <tr>
                      <td colspan="3" class="px-4 py-8 text-center text-gray-400 text-sm">No data available</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Download Options -->
            <div class="bg-gray-50 rounded-2xl p-4">
              <h3 class="text-sm font-semibold text-gray-700 mb-3">Download Data</h3>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <button onclick="downloadCSV('summary')" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors btn-press">
                  <i data-lucide="file-spreadsheet" class="w-4 h-4 text-emerald-600"></i>
                  <span class="text-sm font-medium text-gray-700">Summary</span>
                </button>
                <button onclick="downloadCSV('consumption')" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors btn-press">
                  <i data-lucide="droplets" class="w-4 h-4 text-blue-600"></i>
                  <span class="text-sm font-medium text-gray-700">Consumption</span>
                </button>
                <button onclick="downloadCSV('power')" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors btn-press">
                  <i data-lucide="battery" class="w-4 h-4 text-amber-600"></i>
                  <span class="text-sm font-medium text-gray-700">Power</span>
                </button>
                <button onclick="downloadCSV('control')" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors btn-press">
                  <i data-lucide="settings" class="w-4 h-4 text-purple-600"></i>
                  <span class="text-sm font-medium text-gray-700">Control Logs</span>
                </button>
                <button onclick="downloadCSV('alerts')" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors btn-press">
                  <i data-lucide="alert-triangle" class="w-4 h-4 text-rose-600"></i>
                  <span class="text-sm font-medium text-gray-700">Alerts</span>
                </button>
                <button onclick="downloadFullReport()" 
                        class="flex items-center justify-center gap-2 px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-colors btn-press">
                  <i data-lucide="download" class="w-4 h-4"></i>
                  <span class="text-sm font-medium">Full Report</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div id="summary-empty" class="py-12 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i data-lucide="calendar-search" class="w-8 h-8 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Select a date range</h3>
            <p class="text-sm text-gray-500">Choose your desired date range and click "Generate Report" to view usage summary.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeProfileModal()"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="modal-content bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden relative">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white border-b border-gray-100 p-4 sm:p-6 flex items-center justify-between z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-emerald-100 flex items-center justify-center">
              <i data-lucide="user" class="w-5 h-5 sm:w-6 sm:h-6 text-emerald-600"></i>
            </div>
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-gray-900">My Profile</h2>
              <p class="text-xs sm:text-sm text-gray-500">Manage your account settings</p>
            </div>
          </div>
          <button onclick="closeProfileModal()" class="p-2 rounded-xl hover:bg-gray-100 transition-colors">
            <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-4 sm:p-6 overflow-y-auto" style="max-height: calc(90vh - 100px);">
          <!-- Profile Loading -->
          <div id="profile-loading" class="py-12 text-center">
            <div class="w-12 h-12 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-500">Loading profile...</p>
          </div>
          
          <!-- Profile Content -->
          <div id="profile-content" class="hidden space-y-6">
            <!-- Profile Header -->
            <div class="text-center pb-6 border-b border-gray-100">
              <div class="w-20 h-20 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center mx-auto mb-4">
                <span id="profile-avatar" class="text-black font-bold text-3xl">M</span>
              </div>
              <h3 id="profile-name-display" class="text-xl font-bold text-gray-900">User Name</h3>
              <p id="profile-email-display" class="text-sm text-gray-500">user@email.com</p>
              <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-emerald-50 rounded-full">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                <span id="profile-account-id" class="text-xs font-medium text-emerald-700">ACC_XXXXX</span>
              </div>
            </div>
            
            <!-- Profile Tabs -->
            <div class="flex gap-2 p-1 bg-gray-100 rounded-xl">
              <button onclick="switchProfileTab('info')" id="tab-info" class="flex-1 py-2 px-4 text-sm font-medium rounded-lg transition-colors bg-white text-gray-900 shadow-sm">
                Profile Info
              </button>
              <button onclick="switchProfileTab('security')" id="tab-security" class="flex-1 py-2 px-4 text-sm font-medium rounded-lg transition-colors text-gray-500 hover:text-gray-700">
                Security
              </button>
            </div>
            
            <!-- Profile Info Tab -->
            <div id="panel-info" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">First Name</label>
                  <input type="text" id="profile-first-name" 
                         class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">Last Name</label>
                  <input type="text" id="profile-last-name" 
                         class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                </div>
              </div>
              
              <div>
                <label class="block text-xs text-gray-500 mb-1">Device Name</label>
                <input type="text" id="profile-device-name" 
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
              </div>
              
              <div>
                <label class="block text-xs text-gray-500 mb-1">Admin Contact Number</label>
                <input type="tel" id="profile-admin-number" placeholder="+63 XXX XXX XXXX"
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
              </div>
              
              <div>
                <label class="block text-xs text-gray-500 mb-1">Member Since</label>
                <div id="profile-created-at" class="px-4 py-3 rounded-xl bg-gray-50 text-sm text-gray-600">-</div>
              </div>
              
              <button onclick="saveProfileInfo()" 
                      class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-all btn-press flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span>Save Changes</span>
              </button>
            </div>
            
            <!-- Security Tab -->
            <div id="panel-security" class="hidden space-y-6">
              <!-- Change Email -->
              <div class="bg-gray-50 rounded-2xl p-4">
                <h4 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                  <i data-lucide="mail" class="w-4 h-4 text-gray-600"></i>
                  Change Email
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">New Email</label>
                    <input type="email" id="new-email" placeholder="newemail@example.com"
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Current Password</label>
                    <input type="password" id="email-password" placeholder="Enter password to confirm"
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                  </div>
                  <button onclick="updateEmail()" 
                          class="w-full py-2.5 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-xl transition-all btn-press text-sm">
                    Update Email
                  </button>
                </div>
              </div>
              
              <!-- Change Password -->
              <div class="bg-gray-50 rounded-2xl p-4">
                <h4 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                  <i data-lucide="lock" class="w-4 h-4 text-gray-600"></i>
                  Change Password
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Current Password</label>
                    <input type="password" id="current-password" placeholder="Enter current password"
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">New Password</label>
                    <input type="password" id="new-password" placeholder="Enter new password (min 6 chars)"
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                  </div>
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Confirm New Password</label>
                    <input type="password" id="confirm-password" placeholder="Confirm new password"
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all outline-none text-sm">
                  </div>
                  <button onclick="updatePassword()" 
                          class="w-full py-2.5 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-xl transition-all btn-press text-sm">
                    Update Password
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
      
      <!-- Pump Control -->
      <div class="col-span-2 sm:col-span-1 bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center">
            <i data-lucide="power" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"></i>
          </div>
          <div>
            <h2 class="text-sm sm:text-base font-semibold text-gray-900">Pump Control</h2>
                        <div class="flex items-center gap-3 mt-0">
              <div class="flex items-center gap-2">
                <span id="pump-dot" class="w-2 h-2 rounded-full bg-red-500 transition-all duration-300"></span>
                <span id="pump-status" class="text-xs sm:text-sm text-gray-500 font-medium">{{ status.pump }}</span>
              </div>
              <div id="esp32-status" class="flex items-center gap-2 px-2 py-1 sm:px-2 rounded-lg border border-gray-200 bg-gray-50 title="ESP32 Connection Status">
                <div id="esp32-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-xs font-medium text-gray-600">ESP32</span>
                <span id="esp32-status-text" class="text-xs text-gray-500">Offline</span>
              </div>
            </div>
          </div>
        </div>
        <button id="toggle-pump-btn" 
                class="w-full py-3 sm:py-3 bg-gray-900 hover:bg-gray-800 active:bg-gray-700 text-white font-semibold rounded-xl transition-all duration-200 btn-press text-sm sm:text-base">
          Toggle Pump
        </button>
      </div>

      <!-- Water Today -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-emerald-50 flex items-center justify-center">
            <i data-lucide="droplet" class="w-4 h-4 sm:w-5 sm:h-5 text-emerald-600"></i>
          </div>
          <span class="text-xs sm:text-sm text-gray-500 font-medium">Today</span>
        </div>
        <p id="consumption-day" class="text-2xl sm:text-3xl font-bold text-gray-900 value-update">{{ status.consumption_day }}<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span></p>
      </div>

      <!-- Water Week -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-amber-50 flex items-center justify-center">
            <i data-lucide="droplets" class="w-4 h-4 sm:w-5 sm:h-5 text-amber-600"></i>
          </div>
          <span class="text-xs sm:text-sm text-gray-500 font-medium">This Week</span>
        </div>
        <p id="consumption-week" class="text-2xl sm:text-3xl font-bold text-gray-900 value-update">{{ status.consumption_week }}<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span></p>
      </div>

      <!-- Water Month -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-rose-50 flex items-center justify-center">
            <i data-lucide="gauge" class="w-4 h-4 sm:w-5 sm:h-5 text-rose-600"></i>
          </div>
          <span class="text-xs sm:text-sm text-gray-500 font-medium">This Month</span>
        </div>
        <p id="consumption-month" class="text-2xl sm:text-3xl font-bold text-gray-900 value-update">{{ status.consumption_month }}<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span></p>
      </div>
    </div>

    <!-- Flow & Leakage Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
      
      <!-- Inlet Flow -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4 sm:mb-6">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center">
            <i data-lucide="arrow-down-to-line" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"></i>
          </div>
          <h2 class="text-sm sm:text-base font-semibold text-gray-900">Inlet Flow</h2>
        </div>
        <div class="space-y-4">
          <div class="flex items-end justify-between">
            <span class="text-xs sm:text-sm text-gray-500">Flow Rate</span>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 value-update">
              <span id="inlet-flow">{{ status.flow_in }}</span>
              <span class="text-sm text-gray-400 font-medium ml-1">L/min</span>
            </p>
          </div>
          <div class="h-px bg-gray-100"></div>
          <div class="flex items-end justify-between">
            <span class="text-xs sm:text-sm text-gray-500">Total Volume</span>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 value-update">
              <span id="inlet-volume">{{ status.volume_in }}</span>
              <span class="text-sm text-gray-400 font-medium ml-1">L</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Outlet Flow -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4 sm:mb-6">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center">
            <i data-lucide="arrow-up-from-line" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"></i>
          </div>
          <h2 class="text-sm sm:text-base font-semibold text-gray-900">Outlet Flow</h2>
        </div>
        <div class="space-y-4">
          <div class="flex items-end justify-between">
            <span class="text-xs sm:text-sm text-gray-500">Flow Rate</span>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 value-update">
              <span id="outlet-flow">{{ status.flow_out }}</span>
              <span class="text-sm text-gray-400 font-medium ml-1">L/min</span>
            </p>
          </div>
          <div class="h-px bg-gray-100"></div>
          <div class="flex items-end justify-between">
            <span class="text-xs sm:text-sm text-gray-500">Total Volume</span>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 value-update">
              <span id="outlet-volume">{{ status.volume_out }}</span>
              <span class="text-sm text-gray-400 font-medium ml-1">L</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Leakage Detection -->
      <div class="sm:col-span-2 lg:col-span-1 bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4 sm:mb-6">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-green-100 flex items-center justify-center">
            <i data-lucide="shield-check" class="w-5 h-5 sm:w-6 sm:h-6 text-black-700"></i>
          </div>
          <h2 class="text-sm sm:text-base font-semibold text-gray-900">Leakage Detection</h2>
        </div>
        <div id="leak-status" class="flex items-center gap-4 p-4 rounded-xl bg-emerald-50 transition-all duration-300">
          <div class="w-12 h-12 rounded-full bg-emerald-500 flex items-center justify-center flex-shrink-0">
            <i data-lucide="check" class="w-6 h-6 text-black"></i>
          </div>
          <div>
            <p class="font-semibold text-emerald-700 text-sm sm:text-base">System Normal</p>
            <p class="text-xs sm:text-sm text-emerald-600">No leakage detected</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Battery & Chart Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 lg:gap-6">
      
      <!-- Battery Status -->
      <div class="bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4 sm:mb-6">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center">
            <i data-lucide="battery-charging" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"></i>
          </div>
          <h2 class="text-sm sm:text-base font-semibold text-gray-900">Battery Status</h2>
        </div>
        
        <div class="text-center mb-6">
          <p id="battery-percent" class="text-4xl sm:text-5xl font-bold text-gray-900 value-update">80<span class="text-xl sm:text-2xl text-gray-400">%</span></p>
        </div>
        
        <div class="h-4 bg-gray-200 rounded-full overflow-hidden mb-6 shadow-inner">
          <div id="battery-bar" class="h-full bg-emerald-500 rounded-full transition-all duration-500 shadow-sm" style="width: 80%;"></div>
       </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="text-center p-3 bg-gray-50 rounded-xl">
            <p class="text-xs text-gray-500 mb-1">Voltage</p>
            <p id="battery-voltage" class="text-lg sm:text-xl font-bold text-gray-900 value-update">{{ status.battery_voltage }} V</p>
          </div>
          <div class="text-center p-3 bg-gray-50 rounded-xl">
            <p class="text-xs text-gray-500 mb-1">Current</p>
            <p id="current-consumed" class="text-lg sm:text-xl font-bold text-gray-900 value-update">{{ status.current_consumed }} A</p>
          </div>
        </div>
      </div>

      <!-- Flow Chart -->
      <div class="lg:col-span-2 bg-white rounded-2xl sm:rounded-3xl border border-gray-200 p-4 sm:p-6 card-interactive">
        <div class="flex items-center gap-3 mb-4 sm:mb-6">
          <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gray-100 flex items-center justify-center">
            <i data-lucide="trending-up" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700"></i>
          </div>
          <h2 class="text-sm sm:text-base font-semibold text-gray-900">Inlet Flow History</h2>
        </div>
        <div class="h-48 sm:h-64 lg:h-72">
          <canvas id="flowChart"></canvas>
        </div>
      </div>
    </div>
  </main>

<!-- Toast Notification -->
<div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 sm:left-auto sm:translate-x-0 sm:right-4 sm:top-4 bg-gray-900 text-white px-4 sm:px-6 py-3 rounded-xl shadow-lg -translate-y-20 opacity-0 transition-all duration-300 z-50" style="max-width: 90vw;">
  <div class="flex items-center gap-3">
    <i data-lucide="bell" class="w-5 h-5 flex-shrink-0"></i>
    <span id="toast-message" class="text-sm font-medium"></span>
  </div>
</div>

  <script>
  lucide.createIcons();

  // Elements
  const notifBtn = document.getElementById("notif-btn");
  const notifDropdown = document.getElementById("notif-dropdown");
  const notifList = document.getElementById("notif-list");
  const notifCount = document.getElementById("notif-count");
  const mobileNotifCount = document.getElementById("mobile-notif-count");
  const clearNotifBtn = document.getElementById("clear-notif");
  const mobileClearNotif = document.getElementById("mobile-clear-notif");
  const historyBtn = document.getElementById("history-btn");
  const historyDropdown = document.getElementById("history-dropdown");
  const historyList = document.getElementById("history-list");
  const clearHistoryBtn = document.getElementById("clear-history");
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileOverlay = document.getElementById("mobile-overlay");
  const mobileNotifBtn = document.getElementById("mobile-notif-btn");
  const mobileNotifSheet = document.getElementById("mobile-notif-sheet");
  const mobileNotifList = document.getElementById("mobile-notif-list");
  const mobileHistorySheet = document.getElementById("mobile-history-sheet");
  const mobileHistoryList = document.getElementById("mobile-history-list");
  const mobileClearHistory = document.getElementById("mobile-clear-history");
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toast-message");
  const usageSummaryBtn = document.getElementById("usage-summary-btn");
  const mobileReportBtn = document.getElementById("mobile-report-btn");
  const usageModal = document.getElementById("usage-modal");
  const profileBtn = document.getElementById("profile-btn");
  const profileModal = document.getElementById("profile-modal");

  let notifications = [];
  let leakAlertShown = false;
  let lowBatteryAlertShown = false;
  let pumpLastState = "";
  let historyData = JSON.parse(localStorage.getItem("aqua_history") || "[]");
  let summaryChart = null;
  let profileData = null;

  // Initialize date inputs
  function initDateInputs() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
  }

  // Set date range quickly
  function setDateRange(days) {
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - days);
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
  }

  function setThisMonth() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = firstDay.toISOString().split('T')[0];
  }
    // Dark mode & ESP32 functions
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const htmlElement = document.documentElement;
  
  // Load dark mode preference
  function loadDarkMode() {
    const isDark = localStorage.getItem('aqua_dark_mode') === 'true';
    if (isDark) {
      htmlElement.classList.add('dark');
      updateDarkModeIcon(true);
    }
  }
  
  // Update dark mode icon
  function updateDarkModeIcon(isDark) {
    const icon = darkModeToggle?.querySelector('[data-lucide]');
    if (!icon) return;
    if (isDark) {
      icon.setAttribute('data-lucide', 'sun');
    } else {
      icon.setAttribute('data-lucide', 'moon');
    }
    lucide.createIcons();
  }
  
  // Toggle dark mode
  darkModeToggle?.addEventListener('click', () => {
    const isDark = htmlElement.classList.toggle('dark');
    localStorage.setItem('aqua_dark_mode', isDark);
    updateDarkModeIcon(isDark);
    showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled');
  });
  
  // Initialize dark mode on load
  loadDarkMode();
  
  // ESP32 status check
  let esp32Connected = false;
  
  async function checkESP32Status() {
    try {
      const response = await fetch('/status-data');
      if (response.ok) {
        const data = await response.json();
        // expect API to return { esp32_connected: true/false, battery_percent: ..., pump: ... } (if available)
        esp32Connected = data.esp32_connected === true;
        updateESP32Indicator(esp32Connected, data);
      } else {
        updateESP32Indicator(false);
        esp32Connected = false;
      }
    } catch (error) {
      console.error('ESP32 check failed:', error);
      updateESP32Indicator(false);
      esp32Connected = false;
    }
  }
  
  function updateESP32Indicator(connected, data = null) {
    const dot = document.getElementById('esp32-dot');
    const statusText = document.getElementById('esp32-status-text');
    const statusContainer = document.getElementById('esp32-status');
  
    if (!dot || !statusText || !statusContainer) return;
  
    if (connected && data) {
      dot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-500 pulse-glow';
      statusText.textContent = 'Online';
      statusContainer.title = `ESP32 Connected\nBattery: ${data.battery_percent ?? '-'}%\nPump: ${data.pump ?? '-'}`;
      statusContainer.classList.remove('border-gray-200', 'bg-white');
      statusContainer.classList.add('border-emerald-300', 'bg-emerald-50');
    } else {
      dot.className = 'w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse';
      statusText.textContent = 'Offline';
      statusContainer.title = 'ESP32 is offline - showing cached data';
      statusContainer.classList.remove('border-emerald-300', 'bg-emerald-50');
      statusContainer.classList.add('border-gray-200', 'bg-white');
    }
  }
  
  // initial check and periodic checks
  checkESP32Status();
  setInterval(checkESP32Status, 5000);
  // Usage Summary Modal Functions
  function openUsageSummaryModal() {
    usageModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    initDateInputs();
    lucide.createIcons();
  }

  function closeUsageSummaryModal() {
    usageModal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  usageSummaryBtn?.addEventListener('click', openUsageSummaryModal);
  mobileReportBtn?.addEventListener('click', openUsageSummaryModal);

  // Profile Modal Functions
  function openProfileModal() {
    profileModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadProfile();
    lucide.createIcons();
  }

  function closeProfileModal() {
    profileModal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  profileBtn?.addEventListener('click', openProfileModal);

  async function loadProfile() {
    document.getElementById('profile-loading').classList.remove('hidden');
    document.getElementById('profile-content').classList.add('hidden');
    
    try {
      const response = await fetch('/api/profile');
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      profileData = data;
      
      // Update profile display
      document.getElementById('profile-avatar').textContent = data.first_name ? data.first_name[0].toUpperCase() : 'U';
      document.getElementById('profile-name-display').textContent = `${data.first_name} ${data.last_name}`;
      document.getElementById('profile-email-display').textContent = data.email;
      document.getElementById('profile-account-id').textContent = data.account_id;
      
      // Fill form fields
      document.getElementById('profile-first-name').value = data.first_name || '';
      document.getElementById('profile-last-name').value = data.last_name || '';
      document.getElementById('profile-device-name').value = data.device_name || '';
      document.getElementById('profile-admin-number').value = data.admin_number || '';
      
      // Format created_at date
      if (data.created_at) {
        const date = new Date(data.created_at);
        document.getElementById('profile-created-at').textContent = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      document.getElementById('profile-loading').classList.add('hidden');
      document.getElementById('profile-content').classList.remove('hidden');
      lucide.createIcons();
      
    } catch (error) {
      console.error('Error loading profile:', error);
      showToast('Failed to load profile');
      closeProfileModal();
    }
  }

  function switchProfileTab(tab) {
    const tabInfo = document.getElementById('tab-info');
    const tabSecurity = document.getElementById('tab-security');
    const panelInfo = document.getElementById('panel-info');
    const panelSecurity = document.getElementById('panel-security');
    
    if (tab === 'info') {
      tabInfo.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
      tabInfo.classList.remove('text-gray-500');
      tabSecurity.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
      tabSecurity.classList.add('text-gray-500');
      panelInfo.classList.remove('hidden');
      panelSecurity.classList.add('hidden');
    } else {
      tabSecurity.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
      tabSecurity.classList.remove('text-gray-500');
      tabInfo.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
      tabInfo.classList.add('text-gray-500');
      panelSecurity.classList.remove('hidden');
      panelInfo.classList.add('hidden');
    }
    lucide.createIcons();
  }

  async function saveProfileInfo() {
    const firstName = document.getElementById('profile-first-name').value.trim();
    const lastName = document.getElementById('profile-last-name').value.trim();
    const deviceName = document.getElementById('profile-device-name').value.trim();
    const adminNumber = document.getElementById('profile-admin-number').value.trim();
    
    if (!firstName || !lastName) {
      showToast('First name and last name are required');
      return;
    }
    
    try {
      const response = await fetch('/api/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          first_name: firstName,
          last_name: lastName,
          device_name: deviceName,
          admin_number: adminNumber
        })
      });
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      showToast('Profile updated successfully!');
      
      // Update displayed name
      document.getElementById('profile-name-display').textContent = `${firstName} ${lastName}`;
      document.getElementById('profile-avatar').textContent = firstName[0].toUpperCase();
      
      // Reload page to update header name
      setTimeout(() => location.reload(), 1000);
      
    } catch (error) {
      console.error('Error saving profile:', error);
      showToast(error.message || 'Failed to save profile');
    }
  }

  async function updateEmail() {
    const newEmail = document.getElementById('new-email').value.trim();
    const password = document.getElementById('email-password').value;
    
    if (!newEmail || !password) {
      showToast('Please fill in all fields');
      return;
    }
    
    // Basic email validation
    if (!newEmail.includes('@') || !newEmail.includes('.')) {
      showToast('Please enter a valid email');
      return;
    }
    
    try {
      const response = await fetch('/api/profile/email', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: newEmail,
          password: password
        })
      });
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      showToast('Email updated successfully!');
      document.getElementById('new-email').value = '';
      document.getElementById('email-password').value = '';
      document.getElementById('profile-email-display').textContent = newEmail;
      
    } catch (error) {
      console.error('Error updating email:', error);
      showToast(error.message || 'Failed to update email');
    }
  }

  async function updatePassword() {
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      showToast('Please fill in all password fields');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showToast('New passwords do not match');
      return;
    }
    
    if (newPassword.length < 6) {
      showToast('Password must be at least 6 characters');
      return;
    }
    
    try {
      const response = await fetch('/api/profile/password', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          current_password: currentPassword,
          new_password: newPassword
        })
      });
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      showToast('Password updated successfully!');
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
      
    } catch (error) {
      console.error('Error updating password:', error);
      showToast(error.message || 'Failed to update password');
    }
  }

  // Fetch Usage Summary
  async function fetchUsageSummary() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
      showToast('Please select both start and end dates');
      return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
      showToast('Start date must be before end date');
      return;
    }
    
    // Show loading
    document.getElementById('summary-loading').classList.remove('hidden');
    document.getElementById('summary-results').classList.add('hidden');
    document.getElementById('summary-empty').classList.add('hidden');
    
    try {
      const response = await fetch(`/api/usage-summary?start_date=${startDate}&end_date=${endDate}`);
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      // Update summary cards
      document.getElementById('summary-total-water').textContent = `${data.summary.total_consumption} L`;
      document.getElementById('summary-avg-daily').textContent = `${data.summary.avg_daily_consumption} L`;
      document.getElementById('summary-pump-cycles').textContent = data.summary.total_pump_cycles;
      document.getElementById('summary-alerts').textContent = data.summary.total_alerts;
      document.getElementById('summary-date-range').textContent = `${startDate} to ${endDate}`;
      
      // Update table
      const tableBody = document.getElementById('summary-table-body');
      if (data.consumption && data.consumption.length > 0) {
        tableBody.innerHTML = data.consumption.map(row => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 text-sm text-gray-900">${row.date}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">${row.consumption_total}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">${row.pump_cycles}</td>
          </tr>
        `).join('');
      } else {
        tableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400 text-sm">No consumption data for this period</td></tr>';
      }
      
      // Update chart
      updateSummaryChart(data.consumption);
      
      // Show results
      document.getElementById('summary-loading').classList.add('hidden');
      document.getElementById('summary-results').classList.remove('hidden');
      
      lucide.createIcons();
      
    } catch (error) {
      console.error('Error fetching summary:', error);
      document.getElementById('summary-loading').classList.add('hidden');
      document.getElementById('summary-empty').classList.remove('hidden');
      showToast('Failed to fetch usage data');
    }
  }

  // Update Summary Chart
  function updateSummaryChart(consumption) {
    const ctx = document.getElementById('summaryChart').getContext('2d');
    
    if (summaryChart) {
      summaryChart.destroy();
    }
    
    const labels = consumption.map(c => c.date);
    const values = consumption.map(c => c.consumption_total);
    
    summaryChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Consumption (L)',
          data: values,
          backgroundColor: 'rgba(16, 185, 129, 0.7)',
          borderColor: 'rgb(16, 185, 129)',
          borderWidth: 1,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: '#f3f4f6', drawBorder: false },
            ticks: { color: '#9ca3af', font: { size: 11 } }
          },
          x: {
            grid: { display: false },
            ticks: { 
              color: '#9ca3af', 
              font: { size: 10 },
              maxRotation: 45,
              minRotation: 45
            }
          }
        },
        plugins: { 
          legend: { display: false }
        }
      }
    });
  }

  // Download CSV
  function downloadCSV(type) {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
      showToast('Please generate a report first');
      return;
    }
    
    window.location.href = `/api/download-csv?start_date=${startDate}&end_date=${endDate}&type=${type}`;
    showToast(`Downloading ${type} data...`);
  }

  // Download Full Report
  function downloadFullReport() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
      showToast('Please generate a report first');
      return;
    }
    
    window.location.href = `/api/download-report?start_date=${startDate}&end_date=${endDate}`;
    showToast('Downloading full report...');
  }

  // Mobile Menu Functions
  function openMobileMenu() {
    mobileMenu.classList.remove("translate-x-full");
    mobileOverlay.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeMobileMenu() {
    mobileMenu.classList.add("translate-x-full");
    mobileOverlay.classList.add("hidden");
    document.body.style.overflow = "";
  }

  function openMobileNotifications() {
    closeMobileMenu();
    mobileNotifSheet.classList.remove("translate-y-full");
    mobileOverlay.classList.remove("hidden");
    mobileNotifCount.classList.add("hidden");
    notifCount.classList.add("hidden");
  }

  function openMobileHistory() {
    closeMobileMenu();
    mobileHistorySheet.classList.remove("translate-y-full");
    mobileOverlay.classList.remove("hidden");
  }

  function closeBottomSheets() {
    mobileNotifSheet.classList.add("translate-y-full");
    mobileHistorySheet.classList.add("translate-y-full");
    mobileOverlay.classList.add("hidden");
  }

  mobileMenuBtn?.addEventListener("click", openMobileMenu);
  mobileNotifBtn?.addEventListener("click", () => {
    openMobileNotifications();
  });
  mobileOverlay?.addEventListener("click", () => {
    closeMobileMenu();
    closeBottomSheets();
  });

  // Desktop Dropdowns
  notifBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    historyDropdown.classList.add("hidden");
    notifDropdown.classList.toggle("hidden");
    if (!notifDropdown.classList.contains("hidden")) {
      notifCount.classList.add("hidden");
    }
  });

  historyBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    notifDropdown.classList.add("hidden");
    historyDropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", (e) => {
    if (!notifDropdown?.contains(e.target) && !notifBtn?.contains(e.target)) {
      notifDropdown?.classList.add("hidden");
    }
    if (!historyDropdown?.contains(e.target) && !historyBtn?.contains(e.target)) {
      historyDropdown?.classList.add("hidden");
    }
  });

  // Clear notifications
  function clearNotifications() {
    notifications = [];
    const emptyHtml = '<li class="p-4 text-center text-gray-400 text-sm">No notifications</li>';
    notifList.innerHTML = emptyHtml;
    mobileNotifList.innerHTML = emptyHtml;
    notifCount.classList.add("hidden");
    mobileNotifCount.classList.add("hidden");
  }
  
  clearNotifBtn?.addEventListener("click", clearNotifications);
  mobileClearNotif?.addEventListener("click", clearNotifications);

  // Toast Notification
  function showToast(message) {
    toastMessage.textContent = message;
    toast.classList.remove("-translate-y-20", "opacity-0");
    setTimeout(() => {
      toast.classList.add("-translate-y-20", "opacity-0");
    }, 3000);
  }

  // History Functions
  function addHistoryEntry(message) {
    const now = new Date();
    const time = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });    if (historyData.length > 50) historyData.pop();
    localStorage.setItem("aqua_history", JSON.stringify(historyData));
    renderHistory();
  }

  function renderHistory() {
    const html = historyData.length === 0 
      ? '<li class="p-4 text-center text-gray-400 text-sm">No history yet</li>'
      : historyData.map(h => `
          <li class="p-4 hover:bg-gray-50 transition-colors">
            <p class="text-sm font-medium text-gray-900">${h.message}</p>
            <p class="text-xs text-gray-400 mt-1">${h.time}</p>
          </li>`).join("");
    
    historyList.innerHTML = html;
    mobileHistoryList.innerHTML = html;
  }

  function clearAllHistory() {
    historyData = [];
    localStorage.removeItem("aqua_history");
    renderHistory();
  }

  clearHistoryBtn?.addEventListener("click", clearAllHistory);
  mobileClearHistory?.addEventListener("click", clearAllHistory);

  renderHistory();

  // Notifications
  function addNotification(message) {
    const now = new Date();
    const time = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    notifications.unshift({ message, time });
    
    const html = notifications.map(n => `
      <li class="p-4 hover:bg-gray-50 transition-colors">
        <p class="text-sm font-medium text-gray-900">${n.message}</p>
        <p class="text-xs text-gray-400 mt-1">${n.time}</p>
      </li>`).join("");
    
    notifList.innerHTML = html;
    mobileNotifList.innerHTML = html;
    
    notifCount.textContent = notifications.length;
    mobileNotifCount.textContent = notifications.length;
    notifCount.classList.remove("hidden");
    mobileNotifCount.classList.remove("hidden");
    
    addHistoryEntry(message);
    showToast(message);
  }

  // Chart
  const ctx = document.getElementById('flowChart').getContext('2d');
  let history = [], labels = [];
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Inlet Flow (L/min)',
        data: history,
        borderColor: '#1f2937',
        backgroundColor: 'rgba(31, 41, 55, 0.05)',
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: '#1f2937',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#f3f4f6', drawBorder: false },
          ticks: { color: '#9ca3af', font: { size: 11 } }
        },
        x: {
          grid: { display: false },
          ticks: { color: '#9ca3af', font: { size: 11 }, maxTicksLimit: 8 }
        }
      },
      plugins: { legend: { display: false } },
      interaction: { intersect: false, mode: 'index' }
    }
  });

  // Update data
  async function updateData() {
    try {
      const res = await fetch('/status-data');
      const data = await res.json();

      // Battery
      const batteryPercent = data.battery_percent ?? 0;
      const bar = document.getElementById("battery-bar");
      const percentDisplay = document.getElementById("battery-percent");
      
      bar.style.width = batteryPercent + "%";
      percentDisplay.innerHTML = batteryPercent + '<span class="text-xl sm:text-2xl text-gray-400">%</span>';
      
      bar.classList.remove("bg-green-500", "bg-orange-500", "bg-red-500");
      if (batteryPercent <= 30) {
        bar.classList.add("bg-red-500");
      } else if (batteryPercent <= 60) {
        bar.classList.add("bg-orange-500");
      } else {
        bar.classList.add("bg-green-500");
      }

      if (batteryPercent <= 10 && !lowBatteryAlertShown) {
        lowBatteryAlertShown = true;
        addNotification("Low Battery Detected");
      }
      if (batteryPercent > 15) lowBatteryAlertShown = false;

      document.getElementById("battery-voltage").textContent = data.battery_voltage + " V";
      document.getElementById("current-consumed").textContent = data.current_consumed + " A";

      // Flows
      document.getElementById("inlet-flow").textContent = data.flow_in;
      document.getElementById("inlet-volume").textContent = data.volume_in;
      document.getElementById("outlet-flow").textContent = data.flow_out;
      document.getElementById("outlet-volume").textContent = data.volume_out;

      // Consumption
      const dayEl = document.getElementById('consumption-day');
      const weekEl = document.getElementById('consumption-week');
      const monthEl = document.getElementById('consumption-month');
      
      dayEl.innerHTML = data.consumption_day + '<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span>';
      weekEl.innerHTML = data.consumption_week + '<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span>';
      monthEl.innerHTML = data.consumption_month + '<span class="text-base sm:text-lg text-gray-400 font-medium ml-1">L</span>';

      // Pump
      const pumpStatus = data.pump;
      const pumpEl = document.getElementById("pump-status");
      const pumpDot = document.getElementById("pump-dot");

      pumpEl.textContent = pumpStatus;
      if (pumpStatus === "ON") {
        pumpDot.classList.remove("bg-red-500");
        pumpDot.classList.add("bg-emerald-500", "pulse-glow");
      } else {
        pumpDot.classList.remove("bg-emerald-500", "pulse-glow");
        pumpDot.classList.add("bg-red-500");
      }

      if (pumpLastState && pumpLastState !== pumpStatus) {
        addNotification(`Pump turned ${pumpStatus}`);
      }
      pumpLastState = pumpStatus;

      // Leakage
      const leakEl = document.getElementById("leak-status");
      if (data.leakage) {
        leakEl.className = "flex items-center gap-4 p-4 rounded-xl bg-red-50 transition-all duration-300";
        leakEl.innerHTML = `
          <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center flex-shrink-0 animate-pulse">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <p class="font-semibold text-red-700 text-sm sm:text-base">Warning!</p>
            <p class="text-xs sm:text-sm text-red-600">Leakage detected</p>
          </div>
        `;
        lucide.createIcons();
        if (!leakAlertShown) {
          addNotification("Leakage Detected!");
          leakAlertShown = true;
        }
      } else {
        leakEl.className = "flex items-center gap-4 p-4 rounded-xl bg-emerald-50 transition-all duration-300";
        leakEl.innerHTML = `
          <div class="w-12 h-12 rounded-full bg-emerald-500 flex items-center justify-center flex-shrink-0">
            <i data-lucide="check" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <p class="font-semibold text-emerald-700 text-sm sm:text-base">System Normal</p>
            <p class="text-xs sm:text-sm text-emerald-600">No leakage detected</p>
          </div>
        `;
        lucide.createIcons();
        leakAlertShown = false;
      }

      // Chart
      history.push(data.flow_in);
      labels.push(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      if (history.length > 20) { history.shift(); labels.shift(); }
      chart.update('none');

    } catch (err) {
      console.error("Error fetching:", err);
    }
  }

  setInterval(updateData, 1500);

  // Toggle Pump
  document.getElementById("toggle-pump-btn")?.addEventListener("click", async () => {
    const btn = document.getElementById("toggle-pump-btn");
    btn.disabled = true;
    btn.textContent = "Toggling...";
    
    try {
      const res = await fetch("/toggle_pump", { method: "POST" });
      const data = await res.json();
      const pumpEl = document.getElementById("pump-status");
      const pumpDot = document.getElementById("pump-dot");

      pumpEl.textContent = data.pump;
      if (data.pump === "ON") {
        pumpDot.classList.remove("bg-red-500");
        pumpDot.classList.add("bg-emerald-500", "pulse-glow");
      } else {
        pumpDot.classList.remove("bg-emerald-500", "pulse-glow");
        pumpDot.classList.add("bg-red-500");
      }
    } catch (err) {
      showToast("Failed to toggle pump!");
    } finally {
      btn.disabled = false;
      btn.textContent = "Toggle Pump";
    }
  });

  // Swipe to close bottom sheets
  let touchStartY = 0;
  [mobileNotifSheet, mobileHistorySheet].forEach(sheet => {
    sheet?.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
    });
    sheet?.addEventListener('touchmove', (e) => {
      const diff = e.touches[0].clientY - touchStartY;
      if (diff > 50) closeBottomSheets();
    });
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeUsageSummaryModal();
      closeProfileModal();
    }
  });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Water Dashboard - Login</title>
  <link href="{{ url_for('static', filename='css/tailwind.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center">

  <!-- Login Page -->
  <div id="loginPage" class="w-full max-w-sm bg-white rounded-2xl shadow p-8">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">ðŸ’§ ESP32 Dashboard</h1>
    
    <form onsubmit="return login(event)" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Username</label>
        <input id="username" type="text" class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300 outline-none" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Password</label>
        <input id="password" type="password" class="w-full border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300 outline-none" required>
      </div>
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition">
        Login
      </button>
      <p id="errorMsg" class="text-red-600 text-sm text-center hidden">Invalid login, try again!</p>
    </form>
  </div>

  <!-- Dashboard (hidden by default) -->
  <div id="dashboard" class="hidden w-full max-w-4xl p-4">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-blue-600">ðŸ’§ ESP32 Water Monitoring</h1>
      <p class="text-gray-500">Real-time pump and flow monitoring</p>
    </header>

    <main class="grid gap-6 md:grid-cols-2">

      <!-- Pump Control -->
      <section class="bg-white rounded-2xl shadow p-6 flex flex-col justify-between">
        <h2 class="text-xl font-semibold mb-4">Pump Control</h2>
        <p class="mb-4">Pump Status: 
          <span class="font-bold text-green-600">{{ status.pump }}</span>
        </p>
        <a href="/toggle_pump" class="w-full">
          <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-xl hover:bg-blue-700 transition">
            Toggle Pump
          </button>
        </a>
      </section>

      <!-- Flow Monitoring -->
      <section class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-semibold mb-4">Flow Monitoring</h2>
        <p class="mb-2">Flow Rate: 
          <span class="font-bold text-blue-600">{{ status.flow }} L/min</span>
        </p>
        <p>Total Volume: 
          <span class="font-bold text-purple-600">{{ status.volume }} L</span>
        </p>
      </section>

      <!-- Chart -->
      <section class="bg-white rounded-2xl shadow p-6 md:col-span-2">
        <h2 class="text-xl font-semibold mb-4">Flow History</h2>
        <canvas id="flowChart" class="w-full h-64"></canvas>
      </section>
    </main>
  </div>

  <script>
    // Simple login (replace with Flask session in production!)
    function login(event) {
      event.preventDefault();
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      const error = document.getElementById("errorMsg");

      if (user === "admin" && pass === "1234") { 
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
      } else {
        error.classList.remove("hidden");
      }
    }

    // Chart setup
    let ctx = document.getElementById('flowChart')?.getContext('2d');
    if (ctx) {
      let history = [], labels = [];
      let chart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: labels, 
          datasets: [{ 
            label: 'Flow L/min', 
            data: history, 
            borderColor: '#2563eb', 
            backgroundColor: 'rgba(37, 99, 235, 0.2)', 
            tension: 0.4, 
            fill: true 
          }] 
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      async function updateData() {
        let res = await fetch('/');
        let text = await res.text();
        let parser = new DOMParser();
        let doc = parser.parseFromString(text, "text/html");
        let flow = parseFloat(doc.querySelector("p:nth-of-type(2)").innerText.split(": ")[1]);

        history.push(flow);
        labels.push(new Date().toLocaleTimeString());
        if (history.length > 20) { history.shift(); labels.shift(); }
        chart.update();
      }

      setInterval(updateData, 2000);
    }
  </script>

</body>
</html>
